version: "3.8"

services:
  go-micro-api:
    container_name: "go-micro-api"
    build:
      context: ..
      dockerfile: config/Dockerfile.dev
    image: "go-micro-api:${APP_VERSION}"
    ports:
      - "${ROUTER_PORT}:${ROUTER_PORT}"
      - "${DELVE_PORT}:${DELVE_PORT}"
    volumes:
      - type: bind
        source: ..
        target: /app
      - type: bind
        source: ../migrations
        target: /app/migrations
    environment:
      - MAIN_DIR=/app/services/go-micro/main.go
      - APP_NAME=go-micro-api
    depends_on:
      - postgres
      - consul
      - cassandra
      - mysql
      - redis
      - prometheus
      - grafana
      - pyroscope
      - mongodb
      - rabbitmq
      - dynamodb
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro
    command: air -c ${AIR_CONFIG}

  monitoring-api:
    container_name: "monitoring-api"
    build:
      context: ..
      dockerfile: config/Dockerfile.dev
    image: "monitoring-api:${APP_VERSION}"
    ports:
      - "${ROUTER_PORT}:${ROUTER_PORT}"
      - "${DELVE_PORT}:${DELVE_PORT}"
    volumes:
      - type: bind
        source: ..
        target: /app
    environment:
      - MAIN_DIR=/app/services/monitoring/main.go
      - APP_NAME=monitoring-api
      - PROMETHEUS_URL=http://prometheus:9090
    depends_on:
      - mysql
      - prometheus
      - grafana
    networks:
      - app-network
    restart: on-failure
    profiles:
      - monitoring    
    command: air -c ${AIR_CONFIG}

  greeter-server:
    container_name: "greeter-server"
    build:
      context: ..
      dockerfile: config/Dockerfile.dev  # Ruta al Dockerfile del servidor
    image: "greeter-server:${APP_VERSION}"
    ports:
      - "${GRPC_SERVER_PORT}:${GRPC_SERVER_PORT}"  # Exponer el puerto del servidor gRPC
      - "${DELVE_PORT_SERVER}:${DELVE_PORT_SERVER}"  # Puerto para debugging con Delve
    environment:
      - DELVE_PORT=${DELVE_PORT_SERVER}  # Sobrescribir el valor de DELVE_PORT para el servidor
      - GRPC_SERVER_HOST=0.0.0.0  # Escuchar en todas las interfaces
      - MAIN_DIR=/app/services/greeter-server/cmd/main.go
      - APP_NAME=greeter-server
      - APP_ROLE=server
    networks:
      - app-network
    volumes:
      - type: bind
        source: ..
        target: /app
    restart: on-failure
    profiles:
      - greeter-server
    command: air -c ${AIR_CONFIG}  
    # command: air -c ${AIR_CONFIG_SERVER}

  greeter-client:
    container_name: "greeter-client"
    build:
      context: ..
      dockerfile: config/Dockerfile.dev # Ruta al Dockerfile del cliente
    image: "greeter-client:${APP_VERSION}"
    ports:
    - "${DELVE_PORT}:${DELVE_PORT}"
    environment:
      - MAIN_DIR=/app/services/greeter-client/cmd/main.go
      - APP_NAME=greeter-client
      - APP_ROLE=client
    network_mode: "host"  # Usa la red del host
    volumes:
      - type: bind
        source: ..
        target: /app
    restart: on-failure
    profiles:
      - greeter-client
    command: air -c ${AIR_CONFIG}
    # command: air -c ${AIR_CONFIG_CLIENT}

  postgres:
    image: postgres:16.3
    container_name: postgres
    ports:
      - "${POSTGRES_HOST_PORT}:${POSTGRES_HOST_PORT}"
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE}
      POSTGRES_USER: ${POSTGRES_USERNAME}
      POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  pgadmin:
    image: dpage/pgadmin4:8.8
    container_name: pgadmin
    ports:
      - "${PGADMIN_PORT}:${PGADMIN_TARGET_PORT}"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    logging:
      driver: "none"
    depends_on:
      - postgres
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  consul:
    image: consul:1.15.4
    container_name: consul
    ports:
      - "${CONSUL_PORT}:${CONSUL_PORT}"
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  cassandra:
    image: cassandra:4.1
    container_name: cassandra
    ports:
      - "${CASSANDRA_PORT}:${CASSANDRA_PORT}"
    environment:
      - CASSANDRA_CLUSTER_NAME=${CASSANDRA_CLUSTER_NAME}
      - CASSANDRA_DC=${CASSANDRA_DC}
      - CASSANDRA_RACK=${CASSANDRA_RACK}
      - CASSANDRA_SEEDS=${CASSANDRA_HOST}
      - CASSANDRA_ENDPOINT_SNITCH=${CASSANDRA_ENDPOINT_SNITCH}
      - CASSANDRA_USERNAME=${CASSANDRA_USERNAME}
      - CASSANDRA_PASSWORD=${CASSANDRA_PASSWORD}
    volumes:
      - cassandra_data:/var/lib/cassandra
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  datastax-studio:
    image: datastax/dse-studio:6.8.32
    container_name: datastax-studio
    ports:
      - "${DS_PORT}:${DS_PORT}"
    depends_on:
      - cassandra
    environment:
      - DS_LICENSE=accept
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  redis:
    image: redis:7.0
    container_name: redis
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "${MYSQL_PORT}:${MYSQL_PORT}"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  phpmyadmin:
    image: phpmyadmin:5.2.1-apache
    container_name: phpmyadmin
    ports:
      - "${PHPMYADMIN_PORT}:${PHPMYADMIN_TARGET_PORT}"
    environment:
      - PMA_HOST=${MYSQL_HOST}
      - PMA_USER=${MYSQL_USER}
      - PMA_PASSWORD=${MYSQL_PASSWORD}
    depends_on:
      - mysql
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  prometheus:
    image: prom/prometheus:v2.45.6
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "${PROMETHEUS_PORT}:${PROMETHEUS_PORT}"
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  grafana:
    image: grafana/grafana:10.2.8
    container_name: grafana
    ports:
      - "${GRAFANA_PORT}:${GRAFANA_PORT}"
    depends_on:
      - prometheus
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  pyroscope:
    image: grafana/pyroscope:weekly-f76-feefa815b
    container_name: pyroscope
    ports:
      - "${PYROSCOPE_PORT}:${PYROSCOPE_PORT}"
    volumes:
      - pyroscope_data:/var/lib/pyroscope
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  mongodb:
    image: mongo:5.0.28
    container_name: mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - "${MONGO_PORT}:${MONGO_PORT}"
    volumes:
      - mongodb_data:/data/db
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    container_name: mongo-express
    environment:
      - ME_CONFIG_MONGODB_ADMINUSERNAME=${MONGO_INITDB_ROOT_USERNAME}
      - ME_CONFIG_MONGODB_ADMINPASSWORD=${MONGO_INITDB_ROOT_PASSWORD}
      - ME_CONFIG_MONGODB_SERVER=${MONGO_HOST}
      - ME_CONFIG_MONGODB_URL=${ME_CONFIG_MONGODB_URL}
    ports:
      - "${ME_PORT}:${ME_PORT}"
    depends_on:
      - mongodb
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  ngrok:
    image: ngrok/ngrok:3.13.0-alpine-91be825
    container_name: ngrok
    command: ["start", "--all", "--config", "/etc/ngrok.yml"]
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml
    ports:
      - "${NGROK_PORT}:${NGROK_PORT}"
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  kong-migrations:
    image: kong:2.8.5-alpine
    command: kong migrations bootstrap
    environment:
      - KONG_DATABASE=${KONG_DATABASE}
      - KONG_PG_HOST=${POSTGRES_HOST}
      - KONG_PG_PORT=${POSTGRES_HOST_PORT}
      - KONG_PG_USER=${POSTGRES_USERNAME}
      - KONG_PG_PASSWORD=${POSTGRES_USER_PASSWORD}
      - KONG_PG_DATABASE=${POSTGRES_DATABASE}
    depends_on:
      - postgres
    networks:
      - app-network
    profiles:
      - go-micro

  kong:
    image: kong:2.8.5-alpine
    container_name: kong
    environment:
      - KONG_DATABASE=${KONG_DATABASE}
      - KONG_PG_HOST=${POSTGRES_HOST}
      - KONG_PG_PORT=${POSTGRES_HOST_PORT}
      - KONG_PG_USER=${POSTGRES_USERNAME}
      - KONG_PG_PASSWORD=${POSTGRES_USER_PASSWORD}
      - KONG_PG_DATABASE=${POSTGRES_DATABASE}
      - KONG_PROXY_ACCESS_LOG=${KONG_PROXY_ACCESS_LOG}
      - KONG_ADMIN_ACCESS_LOG=${KONG_ADMIN_ACCESS_LOG}
      - KONG_PROXY_ERROR_LOG=${KONG_PROXY_ERROR_LOG}
      - KONG_ADMIN_ERROR_LOG=${KONG_ADMIN_ERROR_LOG}
      - KONG_ADMIN_LISTEN=${KONG_ADMIN_LISTEN}
    ports:
      - "${KONG_PROXY_PORT}:${KONG_PROXY_PORT}"
      - "${KONG_PROXY_SSL_PORT}:${KONG_PROXY_SSL_PORT}"
      - "${KONG_ADMIN_PORT}:${KONG_ADMIN_PORT}"
      - "${KONG_ADMIN_SSL_PORT}:${KONG_ADMIN_SSL_PORT}"
    depends_on:
      - kong-migrations
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  rabbitmq:
    image: "rabbitmq:4.0.0-beta.3-management-alpine"
    container_name: rabbitmq
    environment:
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST}
    ports:
      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
      - "${RABBITMQ_MANAGEMENT_PORT}:${RABBITMQ_MANAGEMENT_PORT}"
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  dynamodb:
    image: amazon/dynamodb-local:1.24.0
    container_name: dynamodb
    command: "-jar DynamoDBLocal.jar -port ${DYNAMODB_PORT} -sharedDb -dbPath /home/dynamodblocal/data"
    ports:
      - "${DYNAMODB_PORT}:${DYNAMODB_PORT}"
    volumes:
      - dynamodb_data:/home/dynamodblocal/data
    networks:
      - app-network
    restart: on-failure
    profiles:
      - go-micro

  vault:
    image: vault:1.13.3
    container_name: vault
    ports:
      - "${VAULT_PORT}:${VAULT_PORT}"
    environment:
      VAULT_ADDR: http://localhost:8200
      VAULT_API_ADDR: http://localhost:8200
      VAULT_CLUSTER_ADDR: http://vault:8201
      VAULT_UI: "true"
    volumes:
      - ./vault-config.hcl:/vault/config/vault-config.hcl
      - vault_data:/vault/data
    command: vault server -config=/vault/config/vault-config.hcl
    depends_on:
      - consul
    networks:
      - app-network
    restart: on-failure
    cap_add:
      - IPC_LOCK
    profiles:
      - go-micro

networks:
  app-network:
    driver: bridge

volumes:
  postgres_data:
  pgadmin_data:
  cassandra_data:
  mysql_data:
  pyroscope_data:
  mongodb_data:
  dynamodb_data:
  vault_data:
