FROM golang:1.22.3-alpine3.20

# Install dependencies and Delve for debugging
RUN apk update && \
    apk add --no-cache bash git libc-dev g++ inotify-tools && \
    go install github.com/go-delve/delve/cmd/dlv@latest

# Set the working directory inside the container
WORKDIR /app

# Copy the entrypoint script first and make it executable
COPY ./scripts/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Copy go.mod and go.sum to leverage Docker cache
COPY ./go.mod ./go.sum ./

# Download and verify the project dependencies
RUN go mod download && go mod verify

# Copy the rest of the project files to the container
COPY . .

# Create the bin directory if it doesn't exist
RUN mkdir -p /app/bin

# Expose the necessary ports
EXPOSE 8080 2345

# Define the entrypoint script for the container
CMD ["/entrypoint.sh"]
